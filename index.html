<html lang="en">
	<head>
		<meta charset="utf-8">
		<title>Shot 6</title>
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<meta name="description" content="A first person shooter for the 22nd century.">
		<meta name="author" content="Ajay Tripathy & Kevin Hwang">

		<link href="css/bootstrap.css" rel="stylesheet">
		<link href="css/bootstrap-responsive.css" rel="stylesheet">
		<link href="css/index.css" rel="stylesheet">
		<!-- Don't know if actually does anything ;) -->
    <!--[if lt IE 9]>
      <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

  </head>

  <body>
  	<div id="start">
  		<p>Click me to start!</p>
  	</div>

  	<script src="js/jquery.min.js"></script>
  	<script src="js/three.min.js"></script>
  	<script src="js/index.js"></script>
    <audio id="voice" src="test.mp3" autoplay></audio>
    
    <script>
    

    

    var audioElement = document.querySelector('#voice');

    var context = new webkitAudioContext();
    var analyser = context.createAnalyser();

    //var total = 0;

    var queue = [];

    var iterationNumber = 1;

    function rafCallback(time) {
      console.log('here it is');
      var canvas = document.getElementById('game');
      var freqByteData = new Uint8Array(analyser.frequencyBinCount);
      analyser.getByteFrequencyData(freqByteData);
      var SPACER_WIDTH = 5;
      //var numBars = Math.round(CANVAS_WIDTH / SPACER_WIDTH);

      //ctx.clearRect(0, 0, CANVAS_WIDTH, CANVAS_HEIGHT);

     

      var bandAmplitude = 0
      for (var i = 0; i < freqByteData.length; i++ ){
        //console.log(freqByteData[i])
          
          //console.log(bandAmplitude);
          //var total = bandAmpsTotal[ Math.floor( 32 / (i - 1)) ]
          //console.log(band[0]);
          
        bandAmplitude += freqByteData[i] * freqByteData[i];
        
      }
      queue.push(bandAmplitude);
      
      if (queue.length > 32){
        queue.splice(0,1);
      }

      var total = 0;
      for(var i = 0; i < queue.length; i++){
        total += queue[i];
      }
      var avg = total / queue.length;

      if (bandAmplitude > 1.05 * avg){
          $(document).trigger('beat');
          //THESE ARE BEATZZ. DO STUFF HERE!
      }

      iterationNumber += 1;
      window.webkitRequestAnimationFrame(rafCallback, canvas);
    }

    function onLoad(e) {
      var source = context.createMediaElementSource(audioElement);
      var filter = context.createBiquadFilter();
      filter.type = 0;
      filter.frequency.value = 440;
      source.connect(filter);
      //source.connect(analyser);
      filter.connect(analyser); 
      //analyser.connect(context.destination);
      source.connect(context.destination);

      rafCallback();
    }

    window.addEventListener('load', onLoad, false);

    </script>
  </body>
</html>